# 물탱크 모니터링 시스템 가이드

## 📋 시스템 개요

두 개의 독립적인 물탱크를 모니터링하고 안전하게 관리하는 시스템입니다.

### 1️⃣ 급수 물탱크 (초음파 센서)
- **역할**: 물펌프에 물을 공급하는 메인 물탱크
- **센서**: 초음파 센서 (GPIO 23 TRIG, GPIO 24 ECHO)
- **측정**: 탱크 상단에서 수면까지 거리 측정
- **알림 기준**:
  - 🟢 **정상**: 수위 > 5cm
  - 🟡 **낮음**: 수위 ≤ 5cm (5분마다 알림)
  - 🔴 **위험**: 수위 ≤ 3cm (5분마다 알림, 펌프 차단)

### 2️⃣ 물받이 물탱크 (워터 센서)
- **역할**: 넘친 물을 받는 안전 탱크
- **센서**: 디지털 워터 센서 (GPIO 26)
- **측정**: 물 감지 여부 (True/False)
- **알림 기준**:
  - 🟢 **정상**: 물 감지 안됨 (False)
  - 🔴 **넘침**: 물 감지됨 (True, 5분마다 알림, 펌프 차단)

---

## 🔧 핀 연결

```
급수 물탱크 (초음파 센서)
├─ TRIG → GPIO 23
├─ ECHO → GPIO 24
├─ VCC  → 5V
└─ GND  → GND

물받이 물탱크 (워터 센서)
├─ SIGNAL → GPIO 26 (board.D26)
├─ VCC    → 3.3V
└─ GND    → GND
```

---

## 🚀 동작 흐름

### 메인 루프 (10초마다 실행)

```
1. 급수탱크 체크 (초음파 센서)
   ├─ 거리 측정 → 수위 계산
   ├─ 상태 판단 (정상/낮음/위험)
   └─ 필요시 알림 전송

2. 물받이탱크 체크 (워터 센서)
   ├─ 물 감지 여부 확인
   ├─ 상태 판단 (정상/넘침)
   └─ 필요시 알림 전송

3. 슬롯별 센서 읽기 및 제어
   ├─ 온습도, 조도, 토양수분, CO2 측정
   ├─ MQTT 전송
   └─ 액추에이터 자동 제어
      └─ 물펌프 제어 시 안전 체크
         ├─ 급수탱크 위험? → 펌프 차단
         └─ 물받이탱크 넘침? → 펌프 차단
```

---

## 🔒 안전 로직

### 물펌프 자동 차단 조건

1. **급수탱크 위험 (수위 ≤ 3cm)**
   ```
   🚫 급수탱크 수위 위험 - 물펌프 작동 차단!
   ```
   - 물이 거의 없어 펌프 공회전 방지
   - 펌프 손상 방지

2. **물받이탱크 넘침 (물 감지)**
   ```
   🚫 물받이탱크 넘침 감지 - 물펌프 작동 차단!
   ```
   - 배수 문제 또는 과다 급수
   - 추가 넘침 방지

---

## 📢 알림 시스템

### MQTT 토픽
```
smartfarm/{device_serial}/sensor/nl
```

### 알림 포맷
```
[레벨] [탱크명] 메시지 (타임스탬프)
```

### 알림 예시

**급수탱크 낮음**
```
[WARNING] [급수탱크] 급수 물탱크 수위 낮음 (수위: 4.2cm) 물을 보충하세요. (2025-10-28 14:30:15)
```

**급수탱크 위험**
```
[CRITICAL] [급수탱크] 급수 물탱크 수위 위험! (수위: 2.1cm) 즉시 물을 보충하세요! (2025-10-28 14:35:22)
```

**물받이탱크 넘침**
```
[WARNING] [물받이탱크] 물받이 탱크에 물이 감지되었습니다! 배수를 확인하세요. (2025-10-28 14:40:33)
```

### 알림 쿨다운
- **기본값**: 300초 (5분)
- **목적**: 같은 알림을 너무 자주 보내지 않도록 방지
- **동작**: 마지막 알림 후 5분 이내에는 중복 알림 차단

---

## 📊 상태 모니터링

### 콘솔 출력 예시

**정상 상태**
```
✅ 급수탱크: 정상 (수위: 20.5cm)
✅ 물받이탱크: 정상 (넘침 없음)
```

**경고 상태**
```
⚠️  급수탱크: 낮음 (수위: 4.2cm)
✅ 물받이탱크: 정상 (넘침 없음)

⚠️  물탱크 주의: 급수=낮음, 물받이=정상
```

**위험 상태**
```
🚨 급수탱크: 위험! (수위: 2.1cm)
🚨 물받이탱크: 넘침 감지!

⚠️  물탱크 주의: 급수=위험, 물받이=넘침

🚫 급수탱크 수위 위험 - 물펌프 작동 차단!
🚫 물받이탱크 넘침 감지 - 물펌프 작동 차단!
```

---

## 🛠️ 설정 변경

### `service/water_tank_monitor.py` 파일에서 수정

```python
# 급수 물탱크 설정
self.supply_tank_height = 30          # 탱크 총 높이 (cm)
self.supply_low_threshold = 5         # 낮음 경고 (cm)
self.supply_critical_threshold = 3    # 위험 경고 (cm)

# 알림 쿨다운
self.alert_cooldown = 300  # 5분 (초 단위)
```

**예시: 더 민감하게 설정**
```python
self.supply_low_threshold = 10        # 10cm 이하면 낮음
self.supply_critical_threshold = 5    # 5cm 이하면 위험
self.alert_cooldown = 180             # 3분마다 알림
```

---

## 🧪 테스트 방법

### 1. 물탱크 모니터 단독 테스트
```bash
cd c:\Users\skdml\Desktop\pyhtonbackup
python test/water_tank_test.py
```

**테스트 내용**:
- ✅ 급수탱크 정상/낮음/위험 상태 전환
- ✅ 물받이탱크 정상/넘침 상태 전환
- ✅ 급수 차단 로직
- ✅ 알림 쿨다운 (중복 방지)

### 2. 전체 시스템 테스트
```bash
python main.py
```

---

## 📝 코드 구조

```
pyhtonbackup/
├── main.py                          # 메인 실행 파일 (물탱크 통합)
├── service/
│   ├── water_tank_monitor.py        # 물탱크 모니터링 클래스
│   ├── actuator_control.py          # 액추에이터 제어 (안전 체크 포함)
│   └── read_sensors.py              # 센서 읽기 함수들
├── sensor/
│   ├── water.py                     # 물받이탱크 센서 (디지털)
│   ├── HC_SR04.py                   # 급수탱크 센서 (초음파)
│   └── soil_moisture.py             # 토양수분 센서
└── test/
    └── water_tank_test.py           # 물탱크 테스트
```

---

## ⚠️ 주의사항

1. **초음파 센서 위치**
   - 반드시 탱크 **상단 중앙**에 수평으로 설치
   - 물 표면과 평행하게 측정되도록 배치
   - 탱크 벽면에 너무 가까우면 오측정 가능

2. **워터 센서 위치**
   - 물받이 탱크 **바닥**에 설치
   - 물이 조금만 차도 감지되도록 배치

3. **펌프 차단**
   - 안전을 위해 **자동으로 차단**됨
   - 수동으로 물을 보충한 후 자동 복구됨

4. **알림 확인**
   - MQTT 구독하여 실시간 알림 수신
   - DB 서버에서 알림 로그 확인 가능

---

## 🎯 사용 예시

### 시나리오 1: 정상 운영
```
1. 급수탱크 수위 충분 (20cm)
2. 물받이탱크 비어있음
3. 토양 건조 감지 → 펌프 작동 ✅
4. 정상 급수 진행
```

### 시나리오 2: 급수탱크 낮음
```
1. 급수탱크 수위 낮음 (4cm)
2. 알림 전송: "물을 보충하세요"
3. 토양 건조 감지 → 펌프 작동 ✅ (아직 작동 가능)
4. 사용자가 물 보충
```

### 시나리오 3: 급수탱크 위험
```
1. 급수탱크 수위 위험 (2cm)
2. 알림 전송: "즉시 물을 보충하세요!"
3. 토양 건조 감지 → 펌프 차단 🚫
4. 사용자가 물 보충 후 자동 복구
```

### 시나리오 4: 물받이탱크 넘침
```
1. 물받이탱크에 물 감지
2. 알림 전송: "배수를 확인하세요"
3. 펌프 강제 차단 🚫
4. 배수 문제 해결 후 자동 복구
```

---

## 🔍 문제 해결

### Q1. 초음파 센서가 잘못된 값을 읽어요
**A**: 
- 센서가 물 표면과 평행한지 확인
- 탱크 벽면에서 최소 5cm 이상 떨어뜨려 설치
- 물 표면에 거품이나 이물질이 없는지 확인

### Q2. 알림이 너무 자주 와요
**A**: 
- `water_tank_monitor.py`에서 `alert_cooldown` 값을 늘리세요
- 예: `self.alert_cooldown = 600` (10분)

### Q3. 펌프가 작동하지 않아요
**A**: 
- 콘솔에 "🚫 물탱크 문제로 펌프 강제 정지" 메시지 확인
- 급수탱크 수위 확인 및 물 보충
- 물받이탱크 배수 확인

### Q4. 물받이탱크가 계속 감지되어요
**A**: 
- 배수구가 막혔는지 확인
- 물펌프 급수량이 과도한지 확인
- 센서가 물에 잠겨있는지 확인

---

## 📞 지원

문제가 발생하면:
1. 콘솔 로그 확인
2. MQTT 알림 메시지 확인
3. 테스트 프로그램 실행 (`python test/water_tank_test.py`)
